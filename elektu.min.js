class Colours{constructor(){this.reset()}reset(){this.colour=["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#ffff99","#b15928"]}getNoTeamColour(){return"#C0C0C0"}getRandomColour(){return this.colour.splice(Math.floor(Math.random()*this.colour.length),1)[0]}add(a){this.colour.push(a)}}class PlayerTouch{constructor(a,b,c,d,e){var f=Math.PI;this.radius=20,this.outerCircleStrokeWidth=10,this.x=a,this.y=b,this.id=c,this.colour=d,this.isLocked=!1,this.state="creation",this.number=-1,this.grow=1,this.outerCircleStartAngle=2*Math.random()*f,this.outerCircleEndAngle=this.outerCircleStartAngle,this.isSelected=!1,this.surroundingCircleRadius=1020,this.step=0,this.timeoutStarted=-1,this.timeoutCircleStartAngle=2*Math.random()*f,this.timeoutCircleEndAngle=this.timeoutCircleStartAngle,this.timeoutDuration=e,this.timeoutColor=d+"7F"}moveTo(a,b){this.isLocked||(this.x=a,this.y=b)}computeOuterCircle(){var a=Math.PI;this.outerCircleEndAngle-this.outerCircleStartAngle>=2*a||"onlySelected"===this.state||"selected"===this.state?(this.outerCircleStartAngle=0,this.outerCircleEndAngle=2*a):(this.outerCircleStartAngle+=.08,this.outerCircleEndAngle+=.24)}update(a){var b=Math.PI;switch(this.state){case"creation":40<=this.radius?this.state="normal":this.radius+=5;break;case"deletion":this.radius-=5,0>=this.radius&&(this.radius=0,this.state="obsolete"),this.timeoutStarted=-1;break;case"onlySelected":this.surroundingCircleRadius>this.radius+60&&(this.surroundingCircleRadius-=50),this.timeoutStarted=-1;break;case"selected":this.timeoutStarted=-1;break;default:if(this.step++,4<=this.step&&(this.step=0,37>=this.radius?this.grow=.5:42<=this.radius&&(this.grow=-.5),this.radius+=this.grow),-1!==this.timeoutStarted&&a>this.timeoutStarted){const c=2*((a-this.timeoutStarted)/this.timeoutDuration*b);this.timeoutCircleStartAngle+=.04,this.timeoutCircleEndAngle=this.timeoutCircleStartAngle+c}}this.computeOuterCircle()}startTimer(a){this.timeoutStarted=a}drawTouch(a){a.beginPath(),a.arc(this.x,this.y,this.radius,0,2*Math.PI),a.fill(),a.closePath(),a.beginPath(),a.arc(this.x,this.y,this.radius+12,this.outerCircleStartAngle,this.outerCircleEndAngle),a.lineWidth=this.outerCircleStrokeWidth,a.stroke(),a.closePath()}draw(a){"obsolete"===this.state||(a.fillStyle=this.colour,a.strokeStyle=this.colour,"onlySelected"===this.state&&(a.rect(0,0,a.canvas.clientWidth,a.canvas.clientHeight),a.fill(),a.globalCompositeOperation="xor",a.beginPath(),a.arc(this.x,this.y,this.surroundingCircleRadius,0,2*Math.PI),a.fill(),a.closePath()),this.drawTouch(a),-1!==this.number&&(a.font="50px sans-serif",a.fillText(this.number,this.x,this.y-65)),-1!==this.timeoutStarted&&(a.strokeStyle=this.timeoutColor,a.beginPath(),a.arc(this.x,this.y,this.radius+4,this.timeoutCircleStartAngle,this.timeoutCircleEndAngle),a.lineWidth=9,a.stroke(),a.closePath()))}flagForDelete(){this.state="deletion",this.id=-1}}class Elektu{constructor(a){this.colours=new Colours,this.touches=[],this.canvas=a,this.ctx=a.getContext("2d"),this.ctx.font="50px sans-serif",this.ctx.textAlign="center",this.timerTrigger=-1,this.displayTimeout=1500,this.triggerTimeout=2500,this.finishTouchEnd=this.handleFinishTouchEnd.bind(this),this.touchEnd=this.handleTouchEnd.bind(this),this.newTouch=this.handleNewTouch.bind(this),this.feature="select",this.selectedNumber=1,this.vibrate=!1,this.lastUpdateTimestamp=0,(()=>{this.canvas.addEventListener("touchstart",this.newTouch),this.canvas.addEventListener("touchend",this.touchEnd),this.canvas.addEventListener("touchmove",this.handleTouchMove.bind(this)),this.canvas.addEventListener("touchcancel",this.touchEnd)})()}add(a,b,c){let d="teams"===this.feature?this.colours.getNoTeamColour():this.colours.getRandomColour();this.touches.push(new PlayerTouch(a,b,c,d,this.triggerTimeout))}remove(a){let b=this.getTouch(a);b&&b.flagForDelete()}touchesLength(){let a=0;for(const b of this.touches)"deletion"!==b.state&&"obsolete"!==b.state&&++a;return a}setVibrate(a){this.vibrate=a}setSelectedNumber(a){this.selectedNumber=a}setFeature(a){this.feature=a}getFeature(){return this.feature}areAllTouchesLocked(){for(const a of this.touches)if(!a.isLocked)return!1;return!0}update(a){this.lastUpdateTimestamp=a;for(const b of this.touches)b.update(a);this.touches.forEach((a,b)=>{"obsolete"===a.state&&("teams"!==this.feature&&this.colours.add(a.colour),this.touches.splice(b,1))})}move(a,b,c){let d=this.getTouch(a);d&&d.moveTo(b,c)}reset(){this.touches=[],this.colours.reset(),this.ctx.globalCompositeOperation="source-over",clearTimeout(this.timerTrigger),clearTimeout(this.resetAllTimeout),this.canvas.removeEventListener("touchstart",this.ignoreEvent),this.canvas.removeEventListener("touchmove",this.ignoreEvent),this.canvas.removeEventListener("touchend",this.ignoreEvent),this.canvas.removeEventListener("touchend",this.finishTouchEnd),this.canvas.removeEventListener("touchcancel",this.ignoreEvent),this.canvas.removeEventListener("touchcancel",this.finishTouchEnd),this.canvas.addEventListener("touchstart",this.newTouch),this.canvas.addEventListener("touchend",this.touchEnd),this.canvas.addEventListener("touchcancel",this.touchEnd)}draw(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(const a of this.touches)a.draw(this.ctx)}getTouch(a){for(const b of this.touches)if(a===b.id)return b;return null}resetTimerTrigger(){const a=this.getFeature();if(clearTimeout(this.timerTrigger),"select"===a&&this.touchesLength()>this.selectedNumber||"teams"===a&&this.touchesLength()>=this.selectedNumber||"ordinate"===a){this.timerTrigger=setTimeout(this.triggerSelection.bind(this),this.triggerTimeout);for(let a=0;a<this.touches.length;++a)this.touches[a].startTimer(this.lastUpdateTimestamp)}else for(let a=0;a<this.touches.length;++a)this.touches[a].startTimer(-1)}triggerSelection(){var a=Math.floor;const b=b=>{for(let c,d,e=b.length;0!==e;)c=a(Math.random()*e),e-=1,d=b[e],b[e]=b[c],b[c]=d;return b},c=()=>{const a=[...this.touches].map(a=>a.id);return b(a)},d=a=>{const b=c();b.forEach((b,c)=>{if(c<a){const c=this.getTouch(b);c&&(c.isSelected=!0,c.state=1===a?"onlySelected":"selected")}else this.remove(b)})},e=c=>{const d=[...this.touches].map(a=>a.id);if(c>d.length)throw new RangeError("selectTeams: more elements taken than available");const e=((b,c)=>{var d=Math.ceil;const e=b.length,f=[];let g=0;if(0==e%c)for(const d=a(e/c);g<e;)f.push(b.slice(g,g+=d));else for(;g<e;){const a=d((e-g)/c--);f.push(b.slice(g,g+=a))}return f})(b(d),c);for(const a of e){const b=this.colours.getRandomColour();for(const c of a){const a=this.getTouch(c);a&&(a.colour=b,a.state="selected")}}},f=()=>{const a=c();a.forEach((a,b)=>{const c=this.getTouch(a);c&&(c.number=b+1,c.state="selected")})};switch(clearTimeout(this.timerTrigger),this.getFeature()){case"select":d(this.selectedNumber);break;case"teams":e(this.selectedNumber);break;case"ordinate":f();break;default:throw new Error("Unrecognised feature type.");}this.vibrate&&window.navigator.vibrate([50,10,50]),(()=>{this.canvas.removeEventListener("touchstart",this.newTouch),this.canvas.addEventListener("touchstart",this.ignoreEvent),this.canvas.removeEventListener("touchend",this.touchEnd),this.canvas.addEventListener("touchend",this.finishTouchEnd),this.canvas.removeEventListener("touchcancel",this.touchEnd),this.canvas.addEventListener("touchcancel",this.finishTouchEnd)})()}ignoreEvent(a){a.preventDefault()}handleNewTouch(a){a.preventDefault();for(const b of a.changedTouches)this.add(b.clientX,b.clientY,b.identifier);this.resetTimerTrigger()}handleTouchMove(a){a.preventDefault();for(const b of a.changedTouches)this.move(b.identifier,b.clientX,b.clientY)}handleTouchEnd(a){a.preventDefault();for(const b of a.changedTouches)this.remove(b.identifier);this.resetTimerTrigger()}handleFinishTouchEnd(a){a.preventDefault();for(const b of a.changedTouches){let a=this.getTouch(b.identifier);a&&(a.isLocked=!0)}this.areAllTouchesLocked()&&setTimeout(this.reset.bind(this),this.displayTimeout)}}